name: Flake updates
on:
  schedule:
    # * is a special character in YAML so you have to quote this string
    # run this every Friday
    - cron:  '0 0 * * FRI'
  workflow_dispatch:
    inputs: {}
jobs:
  flake-updater:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Nix
        uses: cachix/install-nix-action@v17
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
      - uses: cachix/cachix-action@v10
        with:
          name: adomixaszvers
          # If you chose signing key for write access
          signingKey: '${{ secrets.CACHIX_SIGNING_KEY }}'
          extraPullNames: 'nix-community'
      - name: Update flake.lock
        uses: DeterminateSystems/update-flake-lock@v9
      - name: Check evaluation
        run: 'find -name "*.nix" -exec nix-instantiate --parse 1>/dev/null {} +'
      - name: Check the flake
        run: 'nix flake check'
      - name: Check home-manager configurations
        run: |-
          nix eval .\#homeConfigurations --apply 'builtins.mapAttrs (_n: v: v.activationPackage.drvPath)'
      # - name: Build NixOS configs
      #   run: |-
      #     nix shell nixpkgs\#nix-build-uncached -c nix-build-uncached ./default.nix -A nixosConfigurations.adomas-jatuzis-nixos.config.system.build.toplevel
      #     nix shell nixpkgs\#nix-build-uncached -c nix-build-uncached ./default.nix -A nixosConfigurations.adomo-nixos.config.system.build.toplevel
      # - name: Build home-manager configs
      #   run: |-
      #     nix shell nixpkgs\#nix-build-uncached -c nix-build-uncached ./default.nix -A homeConfigurations.home.activationPackage
      #     nix shell nixpkgs\#nix-build-uncached -c nix-build-uncached ./default.nix -A homeConfigurations.thinkpad-home.activationPackage
      #     nix shell nixpkgs\#nix-build-uncached -c nix-build-uncached ./default.nix -A homeConfigurations.thinkpad-work.activationPackage
